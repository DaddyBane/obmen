<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Админ панель обменника</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
  .request { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  textarea { width: 100%; height: 60px; margin-top: 5px; }
  button { margin-right: 5px; padding: 5px 10px; cursor: pointer; }
  .status-new { color: blue; }
  .status-waiting_payment { color: orange; }
  .status-paid { color: green; }
  .status-sent { color: gray; }
</style>
</head>
<body>
<h2>Админ панель — заявки на обмен</h2>
<div id="requests"></div>

<script>
  async function loadRequests() {
    const res = await fetch('/api/requests');
    const requests = await res.json();

    const container = document.getElementById('requests');
    container.innerHTML = '';

    requests.forEach(r => {
      const div = document.createElement('div');
      div.className = 'request';
      div.innerHTML = 
        <b>Заявка #${r.id}</b> — <span class="status-${r.status}">${r.status}</span><br/>
        <b>Имя:</b> ${r.name}<br/>
        <b>Контакт:</b> ${r.contact}<br/>
        <b>Отдаёт:</b> ${r.from_currency}<br/>
        <b>Получает:</b> ${r.to_currency}<br/>
        <b>Сумма:</b> ${r.amount}<br/>
        <b>Адрес для крипты:</b><br/>
        <textarea readonly rows="2">${r.crypto_address}</textarea><br/>
        <b>Реквизиты для оплаты:</b><br/>
        <textarea id="payinfo-${r.id}" rows="3">${r.payment_info || ''}</textarea><br/>
        <button onclick="updateStatus(${r.id}, 'waiting_payment')">Выдать реквизиты</button>
        <button onclick="updateStatus(${r.id}, 'paid')">Отметить как оплачено</button>
        <button onclick="updateStatus(${r.id}, 'sent')">Отметить как крипта отправлена</button>
      ;
      container.appendChild(div);
    });
  }

  async function updateStatus(id, status) {
    const payment_info = document.getElementById(payinfo-${id}).value.trim();
    await fetch('/api/update', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({id, status, payment_info})
    });
    loadRequests();
  }

  loadRequests();
  setInterval(loadRequests, 5000);
</script>
</body>
</html>
