<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û–±–º–µ–Ω–Ω–∏–∫ –≤–∞–ª—é—Ç ‚Äî –∑–∞—è–≤–∫–∞</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      flex-direction: column;
      padding: 20px;
    }
    form {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      width: 100%;
      max-width: 420px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      letter-spacing: 1.2px;
    }
    label {
      display: block;
      margin-bottom: 12px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      margin-top: 5px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      outline: none;
      transition: background-color 0.3s ease;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }
    input::placeholder,
    textarea::placeholder {
      color: #ddd;
    }
    input:focus, select:focus, textarea:focus {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 5px 2px #667eea;
    }
    button {
      margin-top: 25px;
      width: 100%;
      padding: 15px;
      background: #6c63ff;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 15px rgba(108, 99, 255, 0.6);
    }
    button:hover {
      background: #5548c8;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(85, 72, 200, 0.7);
    }
    #message {
      margin-top: 20px;
      font-weight: 700;
      font-size: 1rem;
      color: #a0e7a0;
      text-align: center;
      min-height: 1.5em;
    }
    #paymentInfo {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 10px;
      max-width: 420px;
      width: 100%;
      color: #a0e7a0;
      font-weight: 700;
      font-size: 1rem;
      text-align: center;
      min-height: 1.5em;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 480px) {
      form {
        padding: 25px 20px;
        max-width: 90vw;
      }
      #paymentInfo {
        max-width: 90vw;
      }
    }
  </style>
</head>
<body>
  <form id="exchangeForm" autocomplete="off">
    <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–±–º–µ–Ω</h2>
    <label>–ò–º—è:
      <input name="name" placeholder="–í–∞—à–µ –∏–º—è" required />
    </label>
    <label>–ö–æ–Ω—Ç–∞–∫—Ç (Telegram –∏–ª–∏ Email):
      <input name="contact" placeholder="@username –∏–ª–∏ email" required />
    </label>
    <label>–û—Ç–¥–∞—ë—Ç–µ:
      <select name="from_currency">
        <option value="RUB">RUB</option>
      </select>
    </label>
    <label>–ü–æ–ª—É—á–∞–µ—Ç–µ:
      <select name="to_currency" required>
        <option value="USDT TRC-20">USDT TRC-20</option>
        <option value="BTC">BTC</option>
      </select>
    </label>
    <label>–°—É–º–º–∞:
      <input type="number" name="amount" min="1" step="any" placeholder="–°—É–º–º–∞ –¥–ª—è –æ–±–º–µ–Ω–∞" required />
    </label>
    <label>–ê–¥—Ä–µ—Å –¥–ª—è –∫—Ä–∏–ø—Ç—ã:
      <textarea name="crypto_address" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ USDT TRC-20 –∏–ª–∏ BTC –∞–¥—Ä–µ—Å" required></textarea>
    </label>
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <div id="message"></div>
  </form>

  <div id="paymentInfo"></div>

  <script>
    const form = document.getElementById('exchangeForm');
    const msg = document.getElementById('message');
    const paymentDiv = document.getElementById('paymentInfo');

    let intervalId = null;
    let userContact = '';

    async function checkPaymentInfo(contact) {
      try {
        const res = await fetch('/api/requests');
        const requests = await res.json();
        // –ò—â–µ–º –∑–∞—è–≤–∫—É –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç—É —Å –Ω–µ–ø—É—Å—Ç—ã–º–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏
        const userRequest = requests.find(r => r.contact === contact && r.payment_info && r.payment_info.trim() !== '');
        if (userRequest) {
          paymentDiv.textContent = üí∞ –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:\n${userRequest.payment_info};
          if (intervalId) {
            clearInterval(intervalId);
            intervalId = null; // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à–∏–π –æ–ø—Ä–æ—Å
          }
        } else {
          paymentDiv.textContent = "‚è≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –µ—â—ë –Ω–µ –≤—ã–¥–∞–Ω—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...";
        }
      } catch {
        paymentDiv.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.";
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
      paymentDiv.textContent = "";
      userContact = form.contact.value.trim();

      const data = {
        name: form.name.value.trim(),
        contact: userContact,
        from_currency: form.from_currency.value,
        to_currency: form.to_currency.value,
        amount: parseFloat(form.amount.value),
        crypto_address: form.crypto_address.value.trim(),
      };

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if (json.ok) {
          msg.style.color = "#a0e7a0";
          msg.textContent = "‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –û–∂–∏–¥–∞–π—Ç–µ –≤—ã–¥–∞—á—É —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.";
          form.reset();

          // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
          intervalId = setInterval(() => {
            checkPaymentInfo(userContact);
          }, 5000);
        } else {
          msg.style.color = "#f88";
          msg.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏.";
        }
      } catch {
        msg.style.color = "#f88";
        msg.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏.";
      }
    };
  </script>
</body>
</html>
